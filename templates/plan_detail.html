{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">トレーニング詳細：{{ plan.title }}</h4>
  <div class="d-flex gap-2">
    <a href="{{ url_for('plan_edit', plan_id=plan.id) }}"
       class="btn btn-sm btn-outline-primary">編集</a>

    <form method="post" action="{{ url_for('plan_delete', plan_id=plan.id) }}"
          onsubmit="return confirm('この計画と関連する記録を削除します。よろしいですか？');">
      <button class="btn btn-sm btn-outline-danger">削除</button>
    </form>
  </div>
</div>

<div class="mb-2">
  <span class="badge bg-info text-dark">計画日</span>
  <span class="ms-2">{{ plan.planned_date }}</span>
</div>

{% if exercises_list %}
  <div class="mb-3">
    <span class="badge bg-light text-dark mb-1">含まれる種目</span>
    <ul class="mt-1 mb-0 small">
      {% for ex in exercises_list %}
        <li>
          <!-- インデックス名ではなく、個々の種目がクリック可能 -->
          <a href="{{ url_for('exercise_detail', plan_id=plan.id, ex_index=loop.index0) }}">
            {{ ex }}
          </a>
        </li>
      {% endfor %}
    </ul>
    <div class="form-text">
      それぞれの種目名をクリックすると「種目専用ページ」が開き、回数＋経過時間を記録できます。
    </div>
  </div>
{% endif %}

<div class="mb-2">
  <span class="badge bg-secondary">プラン全体の合計時間</span>
  <span class="ms-2 fs-5 fw-bold">{{ total_str }}</span>
</div>

<div class="mb-3">
  <span class="badge bg-light text-dark">予定時間</span>
  <span class="ms-2">{{ plan.planned_minutes }} 分</span>
  <span class="ms-2 small text-muted">(実績 {{ done_minutes }} 分)</span>
</div>

<div class="mb-4" style="max-width:400px;">
  <p class="small text-muted">
    このプラン全体の達成度：{{ plan_progress_percent }}%
  </p>
  <div class="progress" style="height: 18px;">
    <div class="progress-bar bg-{{ plan_progress_color }}"
         role="progressbar"
         style="width: {{ plan_progress_width }}%;"
         aria-valuenow="{{ plan_progress_percent }}"
         aria-valuemin="0" aria-valuemax="100">
      {{ plan_progress_percent }}%
    </div>
  </div>
</div>

{% if plan.notes %}
  <div class="mb-3">
    <span class="badge bg-light text-dark">計画メモ</span>
    <div class="mt-1">{{ plan.notes }}</div>
  </div>
{% endif %}

<hr class="my-3">

<h5 class="mb-2">このプラン全体のログ一覧</h5>
{% if logs %}
  <table class="table table-hover align-middle">
    <thead>
      <tr>
        <th>実施日</th>
        <th>時間 (hh:mm:ss)</th>
        <th>メモ</th>
      </tr>
    </thead>
    <tbody>
    {% for r in logs %}
      <tr>
        <td>{{ r.actual_date }}</td>
        <td>{{ r.duration_str }}</td>
        <td class="small">{{ r.notes or "" }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="text-muted">まだプラン全体のログはありません。</p>
{% endif %}

<hr class="my-3">

<h5 class="mb-2">プラン全体に時間を追加（ストップウォッチ）</h5>

<form method="post" class="card p-3 shadow-sm" style="max-width:700px;">

  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">実施日</label>
      <input type="date" name="actual_date" class="form-control"
             value="{{ today }}" required>
    </div>
  </div>

  <!-- 🔽 カウントダウン設定（共通ストップウォッチ用マークアップ） -->
  <div class="mt-3 mb-2 stopwatch-container">

    <label class="form-label">カウントダウン設定</label>
    <div class="form-check form-switch mb-1">
      <input class="form-check-input stopwatch-countdown-toggle" type="checkbox" id="useCountdownSwitch">
      <label class="form-check-label" for="useCountdownSwitch">
        Start 前にカウントダウン音声を使う
      </label>
    </div>
    <div class="d-flex align-items-center gap-2 mb-2">
      <label class="form-label mb-0 small">カウントダウン秒数（最大10秒）</label>
      <input type="number"
             class="form-control form-control-sm stopwatch-countdown-seconds"
             style="width:80px;"
             value="5" min="1" max="10">
    </div>
    <div class="form-text mb-2">
      例：5 にすると「5,4,3,2,1,0」と女性の声（WAV）でカウントダウンしてから 0:00:00 でスタートします。
    </div>

    <div class="mt-3">
      <div class="d-flex align-items-center gap-3 mb-2">
        <div class="fs-3 fw-bold stopwatch-display">00:00:00</div>
        <!-- ★ 共通JSから更新される隠しフィールド（合計秒数をサーバーに送る） -->
        <input type="hidden"
               name="seconds_total"
               class="stopwatch-seconds-input"
               value="0">
      </div>
      <div class="d-flex gap-2 mb-3">
        <button type="button" class="btn btn-success btn-sm stopwatch-start">Start</button>
        <button type="button" class="btn btn-warning btn-sm stopwatch-stop">Stop</button>
        <button type="button" class="btn btn-secondary btn-sm stopwatch-reset">Reset</button>
      </div>
      <div class="form-text">
        カウントダウンを ON にすると、マイナス表示（-00:00:05 → … → -00:00:00）とともに
        「5,4,3,2,1,0」と読み上げてから計測開始します。0 の後は 00:00:01, 00:00:02 … とカウントアップします。
      </div>
    </div>

  </div>
  <!-- 🔼 カウントダウン設定＆ストップウォッチ（共通クラス付き） -->

  <div class="mb-3 mt-3">
    <label class="form-label">メモ（任意）</label>
    <textarea name="notes" class="form-control" rows="3"
              placeholder="今回の感想やメモなど"></textarea>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-primary">プラン全体時間を追加</button>
    <a href="{{ url_for('day_view', date_str=plan.planned_date) }}" class="btn btn-outline-secondary">
      日別ページに戻る
    </a>
  </div>
</form>

{% endblock %}
