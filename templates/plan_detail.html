{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h4 class="mb-0">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°è©³ç´°ï¼š{{ plan.title }}</h4>
  <div class="d-flex gap-2">
    <a href="{{ url_for('plan_edit', plan_id=plan.id) }}"
       class="btn btn-sm btn-outline-primary">ç·¨é›†</a>

    <form method="post" action="{{ url_for('plan_delete', plan_id=plan.id) }}"
          onsubmit="return confirm('ã“ã®è¨ˆç”»ã¨é–¢é€£ã™ã‚‹è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
      <button class="btn btn-sm btn-outline-danger">å‰Šé™¤</button>
    </form>
  </div>
</div>

<div class="mb-2">
  <span class="badge bg-info text-dark">è¨ˆç”»æ—¥</span>
  <span class="ms-2">{{ plan.planned_date }}</span>
</div>

{% if exercises_list %}
  <div class="mb-3">
    <span class="badge bg-light text-dark mb-1">å«ã¾ã‚Œã‚‹ç¨®ç›®</span>
    <ul class="mt-1 mb-0 small">
      {% for ex in exercises_list %}
        <li>
          <!-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åã§ã¯ãªãã€å€‹ã€…ã®ç¨®ç›®ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ -->
          <a href="{{ url_for('exercise_detail', plan_id=plan.id, ex_index=loop.index0) }}">
            {{ ex }}
          </a>
        </li>
      {% endfor %}
    </ul>
    <div class="form-text">
      ãã‚Œãã‚Œã®ç¨®ç›®åã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Œç¨®ç›®å°‚ç”¨ãƒšãƒ¼ã‚¸ã€ãŒé–‹ãã€å›æ•°ï¼‹çµŒéæ™‚é–“ã‚’è¨˜éŒ²ã§ãã¾ã™ã€‚
    </div>
  </div>
{% endif %}

<div class="mb-2">
  <span class="badge bg-secondary">ãƒ—ãƒ©ãƒ³å…¨ä½“ã®åˆè¨ˆæ™‚é–“</span>
  <span class="ms-2 fs-5 fw-bold">{{ total_str }}</span>
</div>

<div class="mb-3">
  <span class="badge bg-light text-dark">äºˆå®šæ™‚é–“</span>
  <span class="ms-2">{{ plan.planned_minutes }} åˆ†</span>
  <span class="ms-2 small text-muted">(å®Ÿç¸¾ {{ done_minutes }} åˆ†)</span>
</div>

<div class="mb-4" style="max-width:400px;">
  <p class="small text-muted">
    ã“ã®ãƒ—ãƒ©ãƒ³å…¨ä½“ã®é”æˆåº¦ï¼š{{ plan_progress_percent }}%
  </p>
  <div class="progress" style="height: 18px;">
    <div class="progress-bar bg-{{ plan_progress_color }}"
         role="progressbar"
         style="width: {{ plan_progress_width }}%;"
         aria-valuenow="{{ plan_progress_percent }}"
         aria-valuemin="0" aria-valuemax="100">
      {{ plan_progress_percent }}%
    </div>
  </div>
</div>

{% if plan.notes %}
  <div class="mb-3">
    <span class="badge bg-light text-dark">è¨ˆç”»ãƒ¡ãƒ¢</span>
    <div class="mt-1">{{ plan.notes }}</div>
  </div>
{% endif %}

<hr class="my-3">

<h5 class="mb-2">ã“ã®ãƒ—ãƒ©ãƒ³å…¨ä½“ã®ãƒ­ã‚°ä¸€è¦§</h5>
{% if logs %}
  <table class="table table-hover align-middle">
    <thead>
      <tr>
        <th>å®Ÿæ–½æ—¥</th>
        <th>æ™‚é–“ (hh:mm:ss)</th>
        <th>ãƒ¡ãƒ¢</th>
      </tr>
    </thead>
    <tbody>
    {% for r in logs %}
      <tr>
        <td>{{ r.actual_date }}</td>
        <td>{{ r.duration_str }}</td>
        <td class="small">{{ r.notes or "" }}</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="text-muted">ã¾ã ãƒ—ãƒ©ãƒ³å…¨ä½“ã®ãƒ­ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
{% endif %}

<hr class="my-3">

<h5 class="mb-2">ãƒ—ãƒ©ãƒ³å…¨ä½“ã«æ™‚é–“ã‚’è¿½åŠ ï¼ˆã‚¹ãƒˆãƒƒãƒ—ã‚¦ã‚©ãƒƒãƒï¼‰</h5>

<form method="post" class="card p-3 shadow-sm" style="max-width:700px;">

  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">å®Ÿæ–½æ—¥</label>
      <input type="date" name="actual_date" class="form-control"
             value="{{ today }}" required>
    </div>
  </div>

  <!-- ğŸ”½ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š -->
  <div class="mt-3 mb-2">
    <label class="form-label">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š</label>
    <div class="form-check form-switch mb-1">
      <input class="form-check-input" type="checkbox" id="useCountdownSwitch">
      <label class="form-check-label" for="useCountdownSwitch">
        Start å‰ã«ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³éŸ³å£°ã‚’ä½¿ã†
      </label>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0 small">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç§’æ•°ï¼ˆæœ€å¤§10ç§’ï¼‰</label>
      <input type="number" id="countdownSecondsInput" class="form-control form-control-sm"
             style="width:80px;" value="5" min="1" max="10">
    </div>
    <div class="form-text">
      ä¾‹ï¼š5 ã«ã™ã‚‹ã¨ã€Œ5,4,3,2,1,0ã€ã¨é«˜ã‚ã®å¥³æ€§ã®å£°ã§ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã—ã¦ã‹ã‚‰ 0:00:00 ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚
    </div>
  </div>
  <!-- ğŸ”¼ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¨­å®š -->

  <div class="mt-3">
    <div class="d-flex align-items-center gap-3 mb-2">
      <div class="fs-3 fw-bold" id="timerDisplay">00:00:00</div>
      <input type="hidden" id="secondsTotalInput" name="seconds_total" value="0">
    </div>
    <div class="d-flex gap-2 mb-3">
      <button type="button" class="btn btn-success btn-sm" id="btnStart">Start</button>
      <button type="button" class="btn btn-warning btn-sm" id="btnStop">Stop</button>
      <button type="button" class="btn btn-secondary btn-sm" id="btnReset">Reset</button>
    </div>
    <div class="form-text">
      ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’ ON ã«ã™ã‚‹ã¨ã€ãƒã‚¤ãƒŠã‚¹è¡¨ç¤ºï¼ˆ-00:00:05 â†’ â€¦ â†’ -00:00:00ï¼‰ã¨ã¨ã‚‚ã«
      ã€Œ5,4,3,2,1,0ã€ã¨èª­ã¿ä¸Šã’ã¦ã‹ã‚‰è¨ˆæ¸¬é–‹å§‹ã—ã¾ã™ã€‚
    </div>
  </div>

  <div class="mb-3">
    <label class="form-label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea name="notes" class="form-control" rows="3"
              placeholder="ä»Šå›ã®æ„Ÿæƒ³ã‚„ãƒ¡ãƒ¢ãªã©"></textarea>
  </div>

  <div class="d-flex gap-2">
    <button class="btn btn-primary">ãƒ—ãƒ©ãƒ³å…¨ä½“æ™‚é–“ã‚’è¿½åŠ </button>
    <a href="{{ url_for('day_view', date_str=plan.planned_date) }}" class="btn btn-outline-secondary">
      æ—¥åˆ¥ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
    </a>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function () {
  let timerInterval = null;
  let elapsedSeconds = 0;
  let running = false;

  // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç”¨
  let countdownInterval = null;
  let inCountdown = false;
  let countdownRemaining = 0;

  const displayEl = document.getElementById("timerDisplay");
  const secondsHiddenEl = document.getElementById("secondsTotalInput");
  const btnStart = document.getElementById("btnStart");
  const btnStop = document.getElementById("btnStop");
  const btnReset = document.getElementById("btnReset");
  const useCountdownSwitch = document.getElementById("useCountdownSwitch");
  const countdownSecondsInput = document.getElementById("countdownSecondsInput");

  // ---- éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆWeb Speech APIï¼‰----
  function speakNumber(num) {
    if (!("speechSynthesis" in window)) {
      return; // å¯¾å¿œã—ã¦ã„ãªã„ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç„¡éŸ³
    }
    const text = String(num);
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = "ja-JP";
    utter.pitch = 1.6; // å°‘ã—é«˜ã‚ã®å£°
    utter.rate = 1.0;

    const voices = window.speechSynthesis.getVoices();
    const jaVoices = voices.filter(v => v.lang && v.lang.startsWith("ja"));
    if (jaVoices.length > 0) {
      // "female" / "å¥³æ€§" / "Woman" ã£ã½ã„åå‰ã‚’å„ªå…ˆï¼ˆç’°å¢ƒä¾å­˜ï¼‰
      const femaleLike = jaVoices.find(v =>
        /female|å¥³æ€§|Woman|å¥³/i.test(v.name)
      );
      utter.voice = femaleLike || jaVoices[0];
    }

    window.speechSynthesis.speak(utter);
  }

  function formatTimeWithSign(sec, negative) {
    const abs = Math.abs(sec);
    const h = Math.floor(abs / 3600);
    const m = Math.floor((abs % 3600) / 60);
    const s = abs % 60;
    const base =
      String(h).padStart(2, "0") + ":" +
      String(m).padStart(2, "0") + ":" +
      String(s).padStart(2, "0");
    return negative ? "-" + base : base;
  }

  function formatTime(sec) {
    return formatTimeWithSign(sec, false);
  }

  function updateDisplay() {
    displayEl.textContent = formatTime(elapsedSeconds);
    secondsHiddenEl.value = elapsedSeconds;
  }

  function showCountdown(sec) {
    displayEl.textContent = formatTimeWithSign(sec, true);
    secondsHiddenEl.value = 0; // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­ã¯ã¾ã 0æ‰±ã„
  }

  function clearMainTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

  function clearCountdownTimer() {
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
  }

  btnStart.addEventListener("click", () => {
    if (running || inCountdown) return;

    const useCountdown = useCountdownSwitch.checked;
    let cdSeconds = parseInt(countdownSecondsInput.value || "0", 10);
    if (cdSeconds > 10) cdSeconds = 10;
    if (cdSeconds < 1) cdSeconds = 0;

    if (!useCountdown || cdSeconds === 0) {
      // ã„ã¤ã‚‚ã®ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã ã‘
      running = true;
      timerInterval = setInterval(() => {
        elapsedSeconds += 1;
        updateDisplay();
      }, 1000);
      return;
    }

    // ã“ã“ã‹ã‚‰ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ â†’ ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
    inCountdown = true;
    countdownRemaining = cdSeconds;

    // æœ€åˆã®æ•°ï¼ˆä¾‹ï¼š5ï¼‰ã‚’ã™ãã«è¡¨ç¤ºï¼†èª­ã¿ä¸Šã’
    showCountdown(countdownRemaining);
    speakNumber(countdownRemaining);

    countdownInterval = setInterval(() => {
      countdownRemaining -= 1;

      if (countdownRemaining >= 0) {
        // é€”ä¸­ã®æ•°å­—ã¨ã€Œ0ã€ã‚‚è¡¨ç¤ºï¼†èª­ã¿ä¸Šã’
        showCountdown(countdownRemaining);
        speakNumber(countdownRemaining);
      }

      if (countdownRemaining <= 0) {
        // 0 ã‚’èª­ã¿ä¸Šã’ãŸã‚ã¨ã€é€šå¸¸ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—é–‹å§‹
        clearCountdownTimer();
        inCountdown = false;

        elapsedSeconds = 0;
        updateDisplay();
        running = true;
        timerInterval = setInterval(() => {
          elapsedSeconds += 1;
          updateDisplay();
        }, 1000);
      }
    }, 1000);
  });

  btnStop.addEventListener("click", () => {
    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ä¸­ã« Stop ã•ã‚ŒãŸã‚‰ä¸¡æ–¹æ­¢ã‚ã‚‹
    if (inCountdown) {
      inCountdown = false;
      clearCountdownTimer();
    }
    if (!running) return;
    running = false;
    clearMainTimer();
  });

  btnReset.addEventListener("click", () => {
    // ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆ
    inCountdown = false;
    running = false;
    clearCountdownTimer();
    clearMainTimer();
    elapsedSeconds = 0;
    updateDisplay();
  });

  updateDisplay();
});
</script>

{% endblock %}
